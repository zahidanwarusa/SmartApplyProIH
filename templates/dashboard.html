{% extends "base.html" %}

{% block title %}Dashboard - SmartApplyPro{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1><i class="fas fa-chart-line"></i> Dashboard Overview</h1>
    <div class="control-buttons">
        <button id="btn-start" class="btn btn-success" onclick="controlBot('start')">
            <i class="fas fa-play"></i> Start Bot
        </button>
        <button id="btn-pause" class="btn btn-warning" onclick="controlBot('pause')">
            <i class="fas fa-pause"></i> Pause Bot
        </button>
        <button id="btn-stop" class="btn btn-danger" onclick="controlBot('stop')">
            <i class="fas fa-stop"></i> Stop Bot
        </button>
        <button class="btn btn-secondary" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card stat-primary">
        <div class="stat-icon">
            <i class="fas fa-paper-plane"></i>
        </div>
        <div class="stat-content">
            <h3 id="stat-total">0</h3>
            <p>Total Applications</p>
        </div>
    </div>

    <div class="stat-card stat-success">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
            <h3 id="stat-successful">0</h3>
            <p>Successful</p>
        </div>
    </div>

    <div class="stat-card stat-danger">
        <div class="stat-icon">
            <i class="fas fa-times-circle"></i>
        </div>
        <div class="stat-content">
            <h3 id="stat-failed">0</h3>
            <p>Failed</p>
        </div>
    </div>

    <div class="stat-card stat-warning">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
            <h3 id="stat-pending">0</h3>
            <p>Pending</p>
        </div>
    </div>

    <div class="stat-card stat-info">
        <div class="stat-icon">
            <i class="fas fa-calendar-day"></i>
        </div>
        <div class="stat-content">
            <h3 id="stat-today">0</h3>
            <p>Today's Applications</p>
        </div>
    </div>

    <div class="stat-card stat-info">
        <div class="stat-icon">
            <i class="fas fa-calendar-week"></i>
        </div>
        <div class="stat-content">
            <h3 id="stat-week">0</h3>
            <p>This Week</p>
        </div>
    </div>
</div>

<!-- Bot Status Panel -->
<div class="panel">
    <div class="panel-header">
        <h2><i class="fas fa-info-circle"></i> Bot Status</h2>
    </div>
    <div class="panel-body">
        <div class="status-grid">
            <div class="status-item">
                <span class="status-label">Current Status:</span>
                <span id="current-status" class="status-value">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">Uptime:</span>
                <span id="uptime" class="status-value">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">Current Job:</span>
                <span id="current-job" class="status-value">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">Last Activity:</span>
                <span id="last-activity" class="status-value">--</span>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="panel">
    <div class="panel-header">
        <h2><i class="fas fa-history"></i> Recent Activity</h2>
        <button class="btn btn-sm btn-secondary" onclick="loadRecentLogs()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
    <div class="panel-body">
        <div id="recent-logs" class="log-viewer">
            <p class="text-muted">Loading recent activity...</p>
        </div>
    </div>
</div>

<!-- Errors Panel -->
<div class="panel" id="errors-panel" style="display: none;">
    <div class="panel-header panel-danger">
        <h2><i class="fas fa-exclamation-triangle"></i> Recent Errors</h2>
    </div>
    <div class="panel-body">
        <div id="errors-list"></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh dashboard every 5 seconds
let autoRefreshInterval;

function refreshDashboard() {
    fetchStatus();
    loadRecentLogs();
}

function fetchStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            // Update statistics
            const stats = data.statistics;
            document.getElementById('stat-total').textContent = stats.total_applications || 0;
            document.getElementById('stat-successful').textContent = stats.successful || 0;
            document.getElementById('stat-failed').textContent = stats.failed || 0;
            document.getElementById('stat-pending').textContent = stats.pending || 0;
            document.getElementById('stat-today').textContent = stats.today || 0;
            document.getElementById('stat-week').textContent = stats.this_week || 0;

            // Update bot status
            const status = data.status;
            const botStatus = status.status || 'unknown';
            document.getElementById('current-status').textContent = botStatus.toUpperCase();
            document.getElementById('uptime').textContent = data.uptime || 'Not running';
            document.getElementById('current-job').textContent = status.current_job || 'None';
            document.getElementById('last-activity').textContent = formatDateTime(stats.last_activity);

            // Update status indicator
            updateStatusIndicator(botStatus);

            // Show errors if any
            if (status.errors && status.errors.length > 0) {
                displayErrors(status.errors);
            } else {
                document.getElementById('errors-panel').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error fetching status:', error);
        });
}

function loadRecentLogs() {
    fetch('/api/logs?lines=10')
        .then(response => response.json())
        .then(data => {
            const logsDiv = document.getElementById('recent-logs');
            if (data.logs && data.logs.length > 0) {
                logsDiv.innerHTML = data.logs.map(log => 
                    `<div class="log-line">${escapeHtml(log)}</div>`
                ).join('');
            } else {
                logsDiv.innerHTML = '<p class="text-muted">No recent logs available</p>';
            }
        })
        .catch(error => {
            console.error('Error loading logs:', error);
            document.getElementById('recent-logs').innerHTML = 
                '<p class="text-danger">Error loading logs</p>';
        });
}

function controlBot(action) {
    fetch(`/api/control/${action}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Bot ${action}ed successfully`, 'success');
            refreshDashboard();
        } else {
            showNotification(`Failed to ${action} bot`, 'error');
        }
    })
    .catch(error => {
        console.error('Error controlling bot:', error);
        showNotification(`Error: ${error.message}`, 'error');
    });
}

function displayErrors(errors) {
    const errorsPanel = document.getElementById('errors-panel');
    const errorsList = document.getElementById('errors-list');
    
    errorsPanel.style.display = 'block';
    errorsList.innerHTML = errors.map(error => 
        `<div class="error-item">
            <i class="fas fa-exclamation-circle"></i> ${escapeHtml(error)}
        </div>`
    ).join('');
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    refreshDashboard();
    
    // Auto-refresh every 5 seconds
    autoRefreshInterval = setInterval(refreshDashboard, 5000);
});

// Clear interval when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        clearInterval(autoRefreshInterval);
    } else {
        autoRefreshInterval = setInterval(refreshDashboard, 5000);
    }
});
</script>
{% endblock %}
